<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>薛定谔骨牌 - HTML 版</title>
  <style>
    :root{ --bg:#f7f7fb; --fg:#111827; --muted:#6b7280; --card:#ffffff; --blue:#3b82f6; --red:#ef4444; --gray:#9ca3af; --violet:#8b5cf6; --green:#10b981; --warn:#f59e0b; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    .panel{background:var(--card);border:1px solid #e5e7eb;border-radius:12px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.04);margin-bottom:12px}
    h1{margin:0 0 6px;font-size:28px}
    h2{margin:0 0 16px;font-size:14px;font-style:italic;color:var(--muted)}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .group{display:flex;flex-direction:column;gap:8px;min-width:260px;margin-right:12px}
    .group h4{margin:0;font-size:14px;color:#374151}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{appearance:none;border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    button:hover{box-shadow:0 1px 4px rgba(0,0,0,.08)}
    button:disabled{opacity:.6;cursor:not-allowed}
    input[type="number"],input[type="range"],input[type="text"],select,textarea{padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fff}
    textarea.snapshot{width:100%;min-height:64px;font-family:ui-monospace,monospace}
    .grid{display:flex;flex-wrap:wrap;gap:10px;padding:12px;background:var(--card);border:1px dashed #e5e7eb;border-radius:12px}
    .domino{width:26px;height:88px;border-radius:6px;display:flex;align-items:flex-end;justify-content:center;position:relative;transition:transform .35s ease, background-color .2s ease, box-shadow .2s ease;user-select:none}
    .domino .idx{font-size:10px;color:#fff;margin-bottom:4px;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .standing{background:var(--blue)}
    .fallen{background:var(--red);transform:rotate(-78deg) translateY(18px); transform-origin:80% 95%}
    .frozen{background:var(--gray)}
    .entangled{outline:3px dashed var(--violet);outline-offset:2px}
    .selecting{box-shadow:0 0 0 3px rgba(139,92,246,.35) inset, 0 0 0 3px rgba(139,92,246,.35)}
    .badge{display:inline-block;padding:2px 6px;border-radius:999px;background:#eef2ff;color:#4338ca;font-size:12px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .muted{color:var(--muted)} .ok{color:var(--green)} .warn{color:var(--warn)}
    .histrow{display:flex;align-items:center;gap:8px}
    .histlabel{width:60px}
    .histcount{width:50px;text-align:right}
    .histcontainer{flex:1;max-width:520px}
    .histbar{height:10px;background:#c7d2fe;border-radius:6px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left;user-select:none}
    .th-sort{cursor:pointer}
    .th-sort .arrow{font-size:10px;margin-left:4px;opacity:.7}
    .progress{height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden}
    .progress>div{height:100%;background:#93c5fd;transition:width .2s ease}
    .notice{min-height:20px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>薛定谔骨牌</h1>
    <h2>副标题：当骨牌摊上薛定谔，多米诺还有遗憾吗</h2>

    <div class="panel" id="panel-controls">
      <div class="controls" style="align-items:flex-start">
        <div class="group">
          <h4>实验基础</h4>
          <div class="row">数量 N：<input type="number" min="5" max="200" id="inpN" style="width:80px"/></div>
          <div class="row"><button id="btnResetSame">重置（同种子）</button><button id="btnResetNew">重置（新种子）</button></div>
          <div class="row"><button id="btnClearFrozen">清空冻结</button><button id="btnClearEntangle">清空纠缠</button></div>
        </div>
        <div class="group">
          <h4>动力学参数</h4>
          <div class="row">传递效率 η：<input type="range" min="50" max="200" id="rngEff"/> <span class="badge" id="badgeEff"></span></div>
          <div class="row">阈值系数 β：<input type="range" min="50" max="100" id="rngBeta"/> <span class="badge" id="badgeBeta"></span></div>
          <div class="row">量子力场 q：<input type="range" min="0" max="100" id="rngQ"/> <span class="badge" id="badgeQ"></span></div>
        </div>
        <div class="group">
          <h4>动画与统计</h4>
          <div class="row">动画速度：<input type="range" min="80" max="600" id="rngAnim"/> <span class="badge" id="badgeAnim"></span></div>
          <div class="row">统计动画速度：<input type="range" min="80" max="1000" id="rngExpAnim"/> <span class="badge" id="badgeExpAnim"></span></div>
          <div class="row"><button id="btnSim">推倒第一个骨牌（含动画）</button><button id="btnStop">停止动画</button></div>
        </div>
        <div class="group">
          <h4>交互模式</h4>
          <div class="row"><label><input type="checkbox" id="chkFreeze"/> 冻结模式</label></div>
          <div class="row"><label><input type="checkbox" id="chkEntangle"/> 纠缠配对模式</label></div>
          <div class="row"><button id="btnSnapshot">生成快照</button><button id="btnCopy" disabled>复制分享链接</button></div>
        </div>
      </div>
      <div class="notice muted" id="notice" aria-live="polite"></div>
      <details style="margin-top:10px">
        <summary>交互说明</summary>
        <ul>
          <li>编号从 <b>1</b> 开始显示；同一参数与种子下，动画序列可复现。</li>
          <li>排行榜仅记录动画结果，不记录自动实验。</li>
          <li>纠缠：先点选一块高亮，再点第二块建立；冻结块不可纠缠，会提示“骨牌已死，不可纠缠”。</li>
        </ul>
      </details>
      <div id="snapshotBox" style="display:none;margin-top:8px">
        <div class="row">快照（<span id="snapshotLen">0</span> 字符）</div>
        <textarea class="snapshot mono" id="snapshotArea" readonly></textarea>
      </div>
    </div>

    <div class="grid" id="grid" aria-label="domino-grid"></div>

    <div class="panel" id="panel-lb">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">排行榜</h3>
        <button id="btnClearLB">清空排行榜</button>
      </div>
      <div id="lbEmpty" class="muted">暂无记录。进行一次动画模拟后将自动记录。</div>
      <table class="table" id="lbTable" style="display:none">
        <thead>
          <tr>
            <th>#</th>
            <th class="th-sort" data-key="date">日期<span class="arrow"></span></th>
            <th class="th-sort" data-key="n">N<span class="arrow"></span></th>
            <th class="th-sort" data-key="streak">最长连倒<span class="arrow"></span></th>
            <th class="th-sort" data-key="fallen">倒下数量<span class="arrow"></span></th>
            <th class="th-sort" data-key="entangle">纠缠触发<span class="arrow"></span></th>
            <th class="th-sort" data-key="freezeBlocks">冻结阻断<span class="arrow"></span></th>
            <th class="th-sort" data-key="eff">η<span class="arrow"></span></th>
            <th class="th-sort" data-key="beta">β<span class="arrow"></span></th>
            <th class="th-sort" data-key="q">q<span class="arrow"></span></th>
            <th class="th-sort" data-key="seed">seed<span class="arrow"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="panel" id="panel-exp">
      <h3>自动实验（不播放动画，快速统计）</h3>
      <div class="controls">
        <label>实验次数：<input type="number" min="10" max="10000" id="runsInput" style="width:90px" value="200"/></label>
        <label class="row"><input type="checkbox" id="varySeedChk" checked/> 每次用新种子</label>
        <label class="row">统计动画速度：<input type="range" min="80" max="1000" id="rngExpAnim2"/> <span class="badge" id="badgeExpAnim2"></span></label>
        <button id="btnStartExp">开始实验</button>
        <button id="btnStopExp">停止实验</button>
      </div>
      <div class="muted" id="expStatus" style="margin-top:6px"></div>
      <div id="expResult" style="margin-top:10px"></div>
    </div>

    <div class="panel" id="panel-tests">
      <h3>自检测试</h3>
      <div class="controls"><button id="btnTests">Run Self Tests</button></div>
      <pre class="mono" id="testsOut" style="white-space:pre-wrap">(点击 Run Self Tests 执行)</pre>
    </div>
  </div>

  <script>
  (function(){
    // ===== 工具 =====
    function mulberry32(a){ return function(){ let t=(a+=0x6D2B79F5); t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; }; }
    function randNormal(rng){ let u=0,v=0; while(u===0)u=rng(); while(v===0)v=rng(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }
    function b64enc(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
    function b64dec(b64){ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }
    async function tryCopy(text){ try{ await navigator.clipboard.writeText(text); return true; }catch(e){ try{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true; }catch(e2){ return false; } } }

    // ===== 状态 =====
    const state={
      N:24,
      seed:(Date.now()>>>0),
      dominos:[], // {id,mass,fallen,frozen,entangled,selecting}
      q:0.10, eff:1.15, beta:0.80,
      freezeMode:false, entangleMode:false,
      animMs:220, expAnimMs:250,
      timers:[],
      snapshot:"",
      noticeTimer:null,
      lbKey:'sd_lb_v1', lbRows:[], sortKey:'streak', sortAsc:false,
      expStop:false,
    };
    let rng = mulberry32(state.seed>>>0);

    // ===== DOM refs =====
    const $ = sel=>document.querySelector(sel);
    const grid = $('#grid');
    const inpN=$('#inpN'); const rngEff=$('#rngEff'); const rngBeta=$('#rngBeta'); const rngQ=$('#rngQ');
    const badgeEff=$('#badgeEff'); const badgeBeta=$('#badgeBeta'); const badgeQ=$('#badgeQ');
    const rngAnim=$('#rngAnim'); const badgeAnim=$('#badgeAnim'); const rngExpAnim=$('#rngExpAnim'); const badgeExpAnim=$('#badgeExpAnim');
    const chkFreeze=$('#chkFreeze'); const chkEntangle=$('#chkEntangle');
    const btnSim=$('#btnSim'); const btnStop=$('#btnStop');
    const btnResetSame=$('#btnResetSame'); const btnResetNew=$('#btnResetNew'); const btnClearFrozen=$('#btnClearFrozen'); const btnClearEntangle=$('#btnClearEntangle');
    const btnSnapshot=$('#btnSnapshot'); const btnCopy=$('#btnCopy');
    const notice=$('#notice'); const snapshotBox=$('#snapshotBox'); const snapshotArea=$('#snapshotArea'); const snapshotLen=$('#snapshotLen');
    const lbEmpty=$('#lbEmpty'); const lbTable=$('#lbTable'); const lbTbody=lbTable.querySelector('tbody'); const btnClearLB=$('#btnClearLB');
    const runsInput=$('#runsInput'); const varySeedChk=$('#varySeedChk'); const rngExpAnim2=$('#rngExpAnim2'); const badgeExpAnim2=$('#badgeExpAnim2');
    const expStatus=$('#expStatus'); const expResult=$('#expResult');
    const btnStartExp=$('#btnStartExp'); const btnStopExp=$('#btnStopExp');
    const btnTests=$('#btnTests'); const testsOut=$('#testsOut');

    // ===== 初始化 UI 值 =====
    function setBadges(){
      badgeEff.textContent=state.eff.toFixed(2)+'×'; rngEff.value=Math.round(state.eff*100);
      badgeBeta.textContent=state.beta.toFixed(2); rngBeta.value=Math.round(state.beta*100);
      badgeQ.textContent=Math.round(state.q*100)+'%'; rngQ.value=Math.round(state.q*100);
      badgeAnim.textContent=state.animMs+'ms/步'; rngAnim.value=state.animMs;
      badgeExpAnim.textContent=state.expAnimMs+'ms'; rngExpAnim.value=state.expAnimMs;
      badgeExpAnim2.textContent=state.expAnimMs+'ms'; rngExpAnim2.value=state.expAnimMs;
      inpN.value=state.N; chkFreeze.checked=state.freezeMode; chkEntangle.checked=state.entangleMode;
    }

    // ===== 业务逻辑 =====
    function initBySeed(seed, N){
      state.seed=seed>>>0; rng = mulberry32(state.seed>>>0);
      state.N=N; state.dominos=Array.from({length:N},(_,i)=>({id:i,mass:1+2*rng(),fallen:false,frozen:false,entangled:null,selecting:false}));
      renderDominos();
    }

    function renderDominos(){
      grid.innerHTML='';
      const colors=["#8b5cf6","#f59e0b","#10b981","#ef4444","#3b82f6","#a855f7","#06b6d4","#f97316","#22c55e","#eab308"];
      const pairColor=new Map(); let cidx=0;
      // assign stable colors per pair
      state.dominos.forEach(d=>{ if(d.entangled!=null && d.id<d.entangled){ const key=d.id+'-'+d.entangled; if(!pairColor.has(key)){ pairColor.set(key, colors[cidx%colors.length]); cidx++; } } });
      state.dominos.forEach(d=>{
        const div=document.createElement('div');
        const cls=['domino', d.fallen?'fallen':(d.frozen?'frozen':'standing')];
        if(d.entangled!=null) cls.push('entangled');
        if(d.selecting) cls.push('selecting');
        div.className=cls.join(' ');
        if(d.entangled!=null){ const a=Math.min(d.id,d.entangled), b=Math.max(d.id,d.entangled); const key=a+'-'+b; div.style.outlineColor=pairColor.get(key)||'#8b5cf6'; }
        const idx=document.createElement('div'); idx.className='idx'; idx.textContent=String(d.id+1);
        div.appendChild(idx);
        const lines=[`#${d.id+1} 质量: ${d.mass.toFixed(2)}`]; if(d.entangled!=null) lines.push(`纠缠: #${d.entangled+1}`); if(d.frozen) lines.push('已冻结');
        div.title=lines.join('\n');
        div.addEventListener('click',()=>onDominoClick(d.id));
        grid.appendChild(div);
      });
    }

    function willKnock(dMass, nextMass){
      const rnd=0.8+0.4*rng();
      const noise=state.q>0? Math.max(0, 1 + randNormal(rng)*0.6*state.q) : 1.0;
      const force=state.eff*dMass*rnd*noise;
      const threshold=state.beta*nextMass;
      return force>threshold;
    }

    function buildTimeline(startIndex){
      const n=state.dominos.length; const fallen=new Array(n).fill(false); const timeline=[]; const q=[{id:startIndex,step:0}];
      let entangleTriggers=0, freezeBlocks=0;
      while(q.length){
        const cur=q.shift(); const id=cur.id, step=cur.step; const d=state.dominos[id];
        if(!d||fallen[id]||d.frozen){ if(d&&d.frozen) freezeBlocks++; continue; }
        fallen[id]=true; timeline.push({id,step});
        if(d.entangled!=null){ const m=state.dominos[d.entangled]; if(m){ if(!m.frozen && !fallen[m.id]){ q.push({id:m.id,step:step+1}); entangleTriggers++; } else if(m.frozen){ freezeBlocks++; } } }
        const j=id+1; if(j<n){ const n2=state.dominos[j]; if(n2){ if(n2.frozen){ freezeBlocks++; } else if(!fallen[j] && willKnock(d.mass,n2.mass)){ q.push({id:j,step:step+1}); } }
        }
      }
      return {timeline, metrics:{entangleTriggers,freezeBlocks}};
    }

    function computeMetricsFromTimeline(timeline, n, extra){
      const fallen=new Array(n).fill(false); timeline.forEach(e=>fallen[e.id]=true);
      const fallenCount=fallen.reduce((s,x)=>s+(x?1:0),0);
      let best=0,curr=0; for(let i=0;i<n;i++){ if(fallen[i]){curr++; best=Math.max(best,curr);} else curr=0; }
      return { fallenCount, bestStreak:best, entangleTriggers:extra.entangleTriggers, freezeBlocks:extra.freezeBlocks };
    }

    function clearTimers(){ state.timers.forEach(id=>clearTimeout(id)); state.timers=[]; }

    function simulateAnimated(){
      rng = mulberry32(state.seed>>>0); // reproducible
      state.dominos.forEach(d=>{ d.fallen=false; d.selecting=false; });
      renderDominos();
      const built=buildTimeline(0); const tl=built.timeline; const metrics=computeMetricsFromTimeline(tl,state.dominos.length,built.metrics);
      clearTimers();
      tl.forEach((evt,idx)=>{
        const t=evt.step*state.animMs;
        const timer=setTimeout(()=>{
          const d=state.dominos[evt.id]; if(d){ d.fallen=true; renderDominos(); }
          if(idx===tl.length-1){ saveLeaderboardWith(metrics); }
        }, t);
        state.timers.push(timer);
      });
      if(tl.length===0){ saveLeaderboardWith(metrics); }
    }

    function stopAnimation(){ clearTimers(); }

    // ===== 排行榜 =====
    function loadLB(){ try{ return JSON.parse(localStorage.getItem(state.lbKey)||'[]'); }catch{ return []; } }
    function saveLB(rows){ localStorage.setItem(state.lbKey, JSON.stringify(rows.slice(0,50))); }
    function saveLeaderboardWith(m){
      const entry={ date:new Date().toISOString(), seed:state.seed, n:state.N, fallen:m.fallenCount, streak:m.bestStreak, eff:state.eff, beta:state.beta, q:state.q, entangle:m.entangleTriggers, freezeBlocks:m.freezeBlocks };
      const data=loadLB(); data.push(entry); data.sort((a,b)=> b.streak-a.streak || b.fallen-a.fallen ); saveLB(data); state.lbRows=data; renderLB();
    }
    function clearLB(){ localStorage.removeItem(state.lbKey); state.lbRows=[]; renderLB(); }
    function renderLB(){
      const rows=state.lbRows; if(!rows || rows.length===0){ lbEmpty.style.display='block'; lbTable.style.display='none'; return; }
      lbEmpty.style.display='none'; lbTable.style.display='table';
      const arr=[...rows];
      arr.sort((a,b)=>{ const va=a[state.sortKey], vb=b[state.sortKey]; if(va===vb) return 0; const cmp=(va>vb?1:-1); return state.sortAsc? cmp : -cmp; });
      lbTbody.innerHTML='';
      arr.slice(0,50).forEach((e,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${new Date(e.date).toLocaleString()}</td><td>${e.n}</td><td><b>${e.streak}</b></td><td>${e.fallen}</td><td>${e.entangle||0}</td><td>${e.freezeBlocks||0}</td><td>${Number(e.eff).toFixed(2)}</td><td>${Number(e.beta).toFixed(2)}</td><td>${Math.round(Number(e.q)*100)}%</td><td class="mono">${e.seed}</td>`;
        lbTbody.appendChild(tr);
      });
      // update sort arrows
      lbTable.querySelectorAll('th.th-sort').forEach(th=>{
        const key=th.getAttribute('data-key'); const arrow=th.querySelector('.arrow');
        arrow.textContent = (state.sortKey===key) ? (state.sortAsc?'▲':'▼') : '';
      });
    }

    // ===== 自动实验 =====
    async function runExperiment(runs, varySeed){
      state.expStop=false; expStatus.textContent='实验进行中…';
      const counts=[], streaks=[], leadings=[], hist=new Map(); let progress=0;
      const updateUI=()=>{
        const sum=a=>a.reduce((s,x)=>s+x,0); const avg=a=>a.length? sum(a)/a.length : 0; const min=a=>a.length? Math.min(...a) : 0; const max=a=>a.length? Math.max(...a) : 0;
        const meanC=avg(counts), meanS=avg(streaks), meanL=avg(leadings);
        const maxFreq=Math.max(1, ...Array.from(hist.values()));
        const prog=`<div class="progress" style="margin-top:6px"><div style="width:${Math.round(progress*100)}%;transition:width ${Math.max(80,state.expAnimMs)}ms ease"></div></div>`;
        const rows=Array.from(hist.entries()).sort((a,b)=>a[0]-b[0]).map(([k,v])=>{
          const w=Math.round((100*v)/maxFreq);
          return `<div class="histrow"><div class="histlabel">${k}</div><div class="histcontainer"><div class="histbar" style="width:${w}%;transition:width ${Math.max(80,state.expAnimMs)}ms ease"></div></div><div class="histcount">${v}</div></div>`;
        }).join('');
        expResult.innerHTML=`<div><div class="row"><span class="ok">平均倒下</span>: ${meanC.toFixed(2)}，范围 [${min(counts)} ~ ${max(counts)}]</div><div class="row">平均最长连续倒下: ${meanS.toFixed(2)}；平均首段连倒: ${meanL.toFixed(2)}</div>${prog}<h4 style="margin:8px 0 4px">倒下数量分布（频数）</h4>${rows}</div>`;
      };
      function simulateOnceQuick(seedLocal, n){
        const r=mulberry32(seedLocal>>>0); const masses=Array.from({length:n},()=>1+2*r());
        const fallen=new Array(n).fill(false); let best=0,curr=0; const q=[0];
        const tryFall=(i)=>{ if(i<0||i>=n||fallen[i]) return false; fallen[i]=true; return true; };
        while(q.length){ const i=q.shift(); if(!tryFall(i)) continue; curr++; best=Math.max(best,curr);
          const j=i+1; if(j<n){ const rnd=0.8+0.4*r(); const noise=state.q>0? Math.max(0,1+randNormal(r)*0.6*state.q):1.0; const force=state.eff*masses[i]*rnd*noise; const threshold=state.beta*masses[j]; const pass=force>threshold; if(pass) q.push(j); else curr=0; } else curr=0; }
        const fallenCount=fallen.reduce((s,x)=>s+(x?1:0),0); let leading=0; for(let k=0;k<n;k++){ if(fallen[k]) leading++; else break; }
        return {fallenCount, longestStreak:best, leading};
      }
      expResult.innerHTML='';
      for(let r=0;r<runs;r++){
        if(state.expStop){ expStatus.textContent='已停止。'; return; }
        const s=varySeed? ((state.seed + r*2654435761)>>>0) : state.seed;
        const res=simulateOnceQuick(s, state.N);
        counts.push(res.fallenCount); streaks.push(res.longestStreak); leadings.push(res.leading);
        hist.set(res.fallenCount,(hist.get(res.fallenCount)||0)+1);
        if(r%10===0){ progress=(r+1)/runs; expStatus.textContent=`进度 ${r+1}/${runs}…`; updateUI(); await new Promise(res=>setTimeout(res,0)); }
      }
      progress=1; expStatus.textContent='完成。'; updateUI();
    }

    // ===== 快照 =====
    function buildSnapshot(){
      const frozenIdx=state.dominos.filter(d=>d.frozen).map(d=>d.id);
      const pairs=[]; const seen=new Set(); state.dominos.forEach(d=>{ if(d.entangled!=null && !seen.has(d.id) && !seen.has(d.entangled)){ pairs.push([d.id,d.entangled]); seen.add(d.id); seen.add(d.entangled); } });
      const snap={ seed:state.seed, n:state.N, pairs, frozen:frozenIdx, q:state.q, eff:state.eff, beta:state.beta, speed:state.animMs };
      return b64enc(snap);
    }
    function generateSnapshot(){ const payload=buildSnapshot(); state.snapshot=payload; snapshotArea.value=payload; snapshotLen.textContent=String(payload.length); snapshotBox.style.display='block'; btnCopy.disabled=false; toast('已生成快照'); }
    async function copyShare(){ if(!state.snapshot){ alert('请先点击“生成快照”'); return; } const url=location.origin+location.pathname+'#'+encodeURIComponent(state.snapshot); const ok=await tryCopy(url); if(ok){ toast('已复制分享链接'); } else { window.prompt('复制失败，请手动复制以下链接：', url); } }

    // ===== 自检 =====
    function runSelfTests(){ const out=[]; const det=(d,n,eff,beta,rnd=1,noise=1)=> eff*d*rnd*noise>beta*n; out.push(`T1b(η↑, 概率不减): ${Number(det(2,1.5,1.3,0.8))>=Number(det(2,1.5,1.1,0.8))?'PASS':'FAIL'}`); out.push(`T1c(β↑, 概率不增): ${Number(det(2,1.5,1.2,0.9))<=Number(det(2,1.5,1.2,0.8))?'PASS':'FAIL'}`); const quick=(sd)=>{ const r=mulberry32(sd>>>0); const masses=Array.from({length:20},()=>1+2*r()); const d0=masses[0], d1=masses[1]; return state.eff*d0*1*1>state.beta*d1; }; const r1=quick(123456789), r2=quick(123456789); out.push(`T2(同种子一致): ${r1===r2?'PASS':'FAIL'}`); const snap1=buildSnapshot(); out.push(`T3(快照生成非空): ${snap1 && snap1.length>10 ? 'PASS':'FAIL'}`); const url=location.origin+location.pathname+'#'+encodeURIComponent(snap1); out.push(`T4(URL 构造含 #): ${url.indexOf('#')>0?'PASS':'FAIL'}`); out.push(`T5(换行拼接\\n): ${['a','b'].join('\n')==='a\nb'?'PASS':'FAIL'}`); const probe={seed:1,n:2,q:0.1,eff:1.1,beta:0.8,speed:200,frozen:[0],pairs:[[0,1]]}; const dec=b64dec(b64enc(probe)); out.push(`T6(快照字段一致:seed/n): ${(dec.seed===1 && dec.n===2)?'PASS':'FAIL'}`); const titleJoined=['#1 质量:1.00','已冻结'].join('\n'); out.push(`T7(title 拼接\\n): ${titleJoined.indexOf('\n')>0 ? 'PASS':'FAIL'}`); testsOut.textContent=out.join('\n'); }

    // ===== 交互 =====
    function onDominoClick(id){ const d=state.dominos[id]; if(state.entangleMode){ if(d.frozen){ toast('骨牌已死，不可纠缠'); return; } if(d.entangled!=null){ const mate=d.entangled; d.entangled=null; const m=state.dominos[mate]; if(m && m.entangled===id) m.entangled=null; d.selecting=false; renderDominos(); return; } const selecting=state.dominos.findIndex(x=>x && x.selecting===true); if(selecting===-1){ d.selecting=true; renderDominos(); return; } if(selecting===id){ d.selecting=false; renderDominos(); return; } const sDom=state.dominos[selecting]; if(sDom.frozen){ toast('骨牌已死，不可纠缠'); sDom.selecting=false; renderDominos(); return; } sDom.entangled=id; d.entangled=selecting; sDom.selecting=false; renderDominos(); } else if(state.freezeMode){ d.frozen=!d.frozen; if(!d.frozen){ /* unfreeze keeps fallen */ } d.selecting=false; renderDominos(); } }

    function toast(msg){ clearTimeout(state.noticeTimer); notice.textContent=msg; state.noticeTimer=setTimeout(()=>{ notice.textContent=''; }, 1200); }

    function resetSame(){ stopAnimation(); initBySeed(state.seed, state.N); }
    function resetNew(){ stopAnimation(); const s=(Date.now()^Math.floor(Math.random()*1e9))>>>0; initBySeed(s, state.N); }
    function clearFrozen(){ state.dominos.forEach(x=>{ x.frozen=false; x.fallen=false; }); renderDominos(); }
    function clearEntangle(){ state.dominos.forEach(x=>{ x.entangled=null; x.selecting=false; }); renderDominos(); }

    // ===== 事件绑定 =====
    rngEff.addEventListener('input',()=>{ state.eff=Number(rngEff.value)/100; badgeEff.textContent=state.eff.toFixed(2)+'×'; });
    rngBeta.addEventListener('input',()=>{ state.beta=Number(rngBeta.value)/100; badgeBeta.textContent=state.beta.toFixed(2); });
    rngQ.addEventListener('input',()=>{ state.q=Number(rngQ.value)/100; badgeQ.textContent=Math.round(state.q*100)+'%'; });
    rngAnim.addEventListener('input',()=>{ state.animMs=Number(rngAnim.value); badgeAnim.textContent=state.animMs+'ms/步'; });
    rngExpAnim.addEventListener('input',()=>{ state.expAnimMs=Number(rngExpAnim.value); badgeExpAnim.textContent=state.expAnimMs+'ms'; badgeExpAnim2.textContent=state.expAnimMs+'ms'; rngExpAnim2.value=state.expAnimMs; });
    rngExpAnim2.addEventListener('input',()=>{ state.expAnimMs=Number(rngExpAnim2.value); badgeExpAnim2.textContent=state.expAnimMs+'ms'; badgeExpAnim.textContent=state.expAnimMs+'ms'; rngExpAnim.value=state.expAnimMs; });
    chkFreeze.addEventListener('change',()=>{ state.freezeMode=chkFreeze.checked; });
    chkEntangle.addEventListener('change',()=>{ state.entangleMode=chkEntangle.checked; });
    inpN.addEventListener('change',()=>{ const v=Math.max(5,Math.min(200, Number(inpN.value)||24)); initBySeed(state.seed, v); });

    btnSim.addEventListener('click',simulateAnimated);
    btnStop.addEventListener('click',stopAnimation);
    btnResetSame.addEventListener('click',resetSame);
    btnResetNew.addEventListener('click',resetNew);
    btnClearFrozen.addEventListener('click',clearFrozen);
    btnClearEntangle.addEventListener('click',clearEntangle);

    btnSnapshot.addEventListener('click',generateSnapshot);
    btnCopy.addEventListener('click',copyShare);

    btnStartExp.addEventListener('click',()=>{ const runs=Math.max(10,Math.min(10000, Number(runsInput.value)||200)); const vary=varySeedChk.checked; runExperiment(runs, vary); });
    btnStopExp.addEventListener('click',()=>{ state.expStop=true; expStatus.textContent='已停止。'; });

    btnTests.addEventListener('click',runSelfTests);

    // ===== 排行榜排序 =====
    lbTable.querySelectorAll('th.th-sort').forEach(th=>{ th.addEventListener('click',()=>{ const key=th.getAttribute('data-key'); if(state.sortKey===key){ state.sortAsc=!state.sortAsc; } else { state.sortKey=key; state.sortAsc=false; } renderLB(); }); });
    btnClearLB.addEventListener('click',clearLB);

    // ===== 启动与 hash 导入 =====
    function loadFromHash(){ if(location.hash && location.hash.length>1){ try{ const payload=decodeURIComponent(location.hash.slice(1)); const snap=b64dec(payload); const s=Number.isInteger(snap.seed)? (snap.seed>>>0) : (Date.now()>>>0); const n=Number.isInteger(snap.n)? Math.max(5,Math.min(200,snap.n)) : 24; state.q=typeof snap.q==='number'? snap.q:state.q; state.eff=typeof snap.eff==='number'? snap.eff:state.eff; state.beta=typeof snap.beta==='number'? snap.beta:state.beta; state.animMs=Number.isInteger(snap.speed)? snap.speed:state.animMs; initBySeed(s,n); // apply frozen & pairs
        if(Array.isArray(snap.frozen)) snap.frozen.forEach(i=>{ if(state.dominos[i]) state.dominos[i].frozen=true; });
        if(Array.isArray(snap.pairs)) snap.pairs.forEach(([a,b])=>{ if(state.dominos[a]&&state.dominos[b]){ state.dominos[a].entangled=b; state.dominos[b].entangled=a; } });
        renderDominos(); state.snapshot=payload; snapshotArea.value=payload; snapshotLen.textContent=String(payload.length); snapshotBox.style.display='block'; btnCopy.disabled=false; }catch(e){ console.warn('载入分享快照失败:',e); initBySeed(state.seed,state.N); } } else { initBySeed(state.seed,state.N); } }

    // ===== 初始 UI 赋值与渲染 =====
    state.lbRows=loadLB(); setBadges(); loadFromHash(); renderLB();

  })();
  </script>
</body>
</html>
